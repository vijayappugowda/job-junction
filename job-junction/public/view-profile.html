<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>My Profile ‚Äî Job Junction</title>
<link rel="stylesheet" href="/style.css" />
<style>
body {font-family:Poppins,sans-serif;background:#f5f8ff;margin:0;}
.profile-card {max-width:700px;margin:50px auto;background:#fff;padding:30px;border-radius:16px;box-shadow:0 5px 25px rgba(0,0,0,0.1);text-align:center;}
.profile-card img {width:130px;height:130px;border-radius:50%;object-fit:cover;border:3px solid #2b4eff;}
.profile-card h2 {color:#2b4eff;margin:10px 0 4px;}
button {padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:600;}
#logoutBtn {background:#f44336;color:#fff;}
#editBtn {background:#2b4eff;color:#fff;}
.job-card {background:#f9f9ff;border-radius:8px;margin:10px 0;padding:15px;border:1px solid #eee;text-align:left;}
.job-card h4{margin:0;color:#2b4eff;}
.applications h3{text-align:left;color:#333;}
</style>
</head>
<body>
<div class="profile-card">
  <img id="profileImage" src="/uploads/sample-user.png" />
  <h2 id="profileName">User Name</h2>
  <p id="profileEmail">user@example.com</p>
  <div style="margin-top:10px;">
    <button id="editBtn">Edit Profile</button>
    <button id="logoutBtn">Logout</button>
  </div>
  <div class="applications">
    <h3>Applied Jobs</h3>
    <div id="applicationsList"></div>
    <button onclick="window.location.href='/index.html'" style="background:#00c48c;color:#fff;margin-top:15px;">üè† Go Home</button>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;">
  <div style="background:#fff;padding:25px;border-radius:12px;width:90%;max-width:400px;">
    <h3>Edit Profile</h3>
    <form id="editForm" enctype="multipart/form-data">
      <input name="name" id="editName" placeholder="Full Name" required />
      <input name="password" id="editPassword" placeholder="New Password (optional)" />
      <input type="file" name="profile_image" />
      <button type="submit" style="background:#2b4eff;color:#fff;width:100%;margin-top:10px;">Save</button>
      <button type="button" onclick="document.getElementById('editModal').style.display='none'" style="background:#f44336;color:#fff;width:100%;margin-top:10px;">Cancel</button>
    </form>
  </div>
</div>

<script>
async function loadProfile() {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user) return (window.location.href = '/login.html');

  const res = await fetch(`/profile/${user.id}`);
  const data = await res.json();

  document.getElementById('profileName').textContent = data.profile.name;
  document.getElementById('profileEmail').textContent = data.profile.email;
  document.getElementById('profileImage').src = data.profile.profile_image || '/uploads/sample-user.png';

  const box = document.getElementById('applicationsList');
  if (data.applications.length) {
    box.innerHTML = data.applications.map(a => `
      <div class="job-card">
        <h4>${a.title}</h4>
        <p>${a.company} ‚Äî ${a.location}</p>
        <p>Applied on: ${new Date(a.applied_date).toLocaleDateString()}</p>
        <button onclick="withdraw(${a.appId})" style="background:#f44336;color:#fff;margin-top:6px;">Withdraw</button>
      </div>
    `).join('');
  } else {
    box.innerHTML = '<p>No applications yet.</p>';
  }
}

async function withdraw(appId) {
  if (confirm('Withdraw this application?')) {
    const res = await fetch(`/withdraw/${appId}`, { method: 'DELETE' });
    const data = await res.json();
    alert(data.message);
    loadProfile();
  }
}

document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('user');
  window.location.href = '/login.html';
});

document.getElementById('editBtn').addEventListener('click', () => {
  const user = JSON.parse(localStorage.getItem('user'));
  document.getElementById('editName').value = user.name;
  document.getElementById('editModal').style.display = 'flex';
});

document.getElementById('editForm').addEventListener('submit', async e => {
  e.preventDefault();
  const user = JSON.parse(localStorage.getItem('user'));
  const formData = new FormData(e.target);
  formData.append('id', user.id);
  const res = await fetch('/update-profile', { method: 'POST', body: formData });
  const data = await res.json();
  if (res.ok) {
    alert('Profile updated!');
    localStorage.setItem('user', JSON.stringify(data.updatedUser));
    document.getElementById('editModal').style.display = 'none';
    loadProfile();
  }
});

loadProfile();
</script>
</body>
</html>
